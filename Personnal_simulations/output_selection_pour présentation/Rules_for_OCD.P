primitive(attackerLocated(_domain)).
primitive(vulExists(_domain, _cve, _mod)).
primitive(hostDom(_host, _domain)).

derived(mitm(_domain)).
derived(admin(_domain)).
derived(dcSync(_domain)).
derived(vulnerableHost(_domain)).
derived(classicQCM(_domain)).
derived(validCredentials(_domain)).
derived(lowAccess(_host)).
derived(passTheTicket(_domain)).
derived(coerceHTTP(_domain)).
derived(coerceSMB(_domain)).


meta(attackGoal(_)).
meta(cvss(_vulID, _ac)).


/* RIEN */
interaction_rule(
    (coerceSMB(Domain) :-
        attackerLocated(Domain),
        vulExists(Domain, CVE, smb),
        cvss(CVE, AC)),
    rule_desc('coerceSMB is possible', 'likely')).

/* MITM */
interaction_rule(
    (localAdmin(Domain) :-
        mitm(Domain),
        vulExists(Domain, CVE, ms_08_068),
        cvss(CVE, AC)),
    rule_desc('local admin access is possible', 'likely')).

interaction_rule(
    (dcSync(Domain) :-
        coerceSMB(Domain),
        vulExists(Domain, CVE, coerceSMB_to_dcSync),
        cvss(CVE, AC)),
    rule_desc('dc sync attack is possible from smb into ldap', 'likely')).

/* Classic Quick Compromission Methods */
interaction_rule(
    (vulnerableHost(_) :-
        attackerLocated(Domain)),
    rule_desc('host may be vulnerable', 'unlikely')).

interaction_rule(
    (admin(Host) :-
        attackerLocated(Domain),
        vulExists(Host, CVE, host_to_admin),
        cvss(CVE, AC)),
    rule_desc('cqc attack is possible against admin host or domain', 'likely')).

interaction_rule(
    (lowAccess(Host) :-
        attackerLocated(domain),
        vulExists(Host, CVE, vulnerableHost),
        cvss(CVE, AC)),
    rule_desc('low access is possible', 'likely')).

/* Valid Credentials */
interaction_rule(
    (validCredentials(Domain) :-
        attackerLocated(Domain)),
    rule_desc('valid credentials may be found', 'likely')).

/* Known vulnearbilities */
interaction_rule(
    (passTheTicket(Domain) :-
        validCredentials(Domain),
        vulExists(Domain, CVE, cred_to_ticket),
        cvss(CVE, AC)),
    rule_desc('domain admin access is possible', 'likely')).

interaction_rule(
    (admin(Host) :-
        validCredentials(Domain),
        hostDom(Host, Domain),
        vulExists(Host, CVE, cred_to_admin),
        cvss(CVE, AC)),
    rule_desc('admin access is possible', 'likely')).

interaction_rule(
    (coerceHTTP(Host) :-
        validCredentials(Domain),
        vulExists(Host, CVE, cred_to_coerce_http),
        cvss(CVE, AC)),
    rule_desc('cred_to_coerce_http attack is possible', 'likely')).

interaction_rule(
    (admin(Host) :-
        coerceHTTP(Host),
        vulExists(Host, CVE, coerce_http_to_admin)),
    rule_desc('admin access is possible', 'likely')).

/* Priviege escalation */
interaction_rule(
    (admin(Host) :-
        lowAccess(Host),
        vulExists(Host, CVE, low_to_admin),
        cvss(CVE, AC)),
    rule_desc('privilege escalation', 'likely')).

/* Permissions move */
interaction_rule(
    (admin(Domain) :-
        dcSync(Domain),
        vulExists(Domain, V, dcSync_to_domadmin)),
    rule_desc('dc Sync', 'likely')).

/* Lateral move */
interaction_rule(
    (dcSync(DC) :-
        passTheTicket(DC),
        vulExists(DC, V, passTicket_to_dcsync)),
    rule_desc('lateral move to dcsync', 'likely')).

/* ADCS */
interaction_rule(
    (passTheTicket(Domain) :-
        coerceHTTP(Domain),
        vulExists(Domain, V, adcs)),
    rule_desc('ECS8 from http to pass the ticket', 'likely')).
